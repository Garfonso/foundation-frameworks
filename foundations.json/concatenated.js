var MojoLoader=require("mojoloader.js"),IMPORTS=MojoLoader.require({name:"foundations",version:"1.0"}),Foundations=IMPORTS.foundations,Class=Foundations.Class,jsonQuery; (function(){jsonQuery=function(c,d){function f(a){e=a+"("+e}function l(a,b,c,e,l,d,f,g){return k[g].match(/[\*\?]/)||"~"==f?"/^"+k[g].substring(1,k[g].length-1).replace(/\\([btnfr\\"'])|([^\w\*\?])/g,"\\$1$2").replace(/([\*\?])/g,"[\\w\\W]$1")+("~"==f?"$/i":"$/")+".test("+b+")":a}var g=0,k=[];c=c.replace(/"(\\.|[^"\\])*"|'(\\.|[^'\\])*'|[\[\]]/g,function(a){g+="["==a?1:"]"==a?-1:0;return"]"==a&&0<g?"`]":'"'==a.charAt(0)||"'"==a.charAt(0)?"`"+(k.push(a)-1):a});var e="";c.replace(/(\]|\)|push|pop|shift|splice|sort|reverse)\s*\(/, function(){throw Error("Unsafe function call");});c=c.replace(/([^=]=)([^=])/g,"$1=$2").replace(/@|(\.\s*)?[a-zA-Z\$_]+(\s*:)?/g,function(a){return"."==a.charAt(0)?a:"@"==a?"$obj":(a.match(/:|^(\$|Math|true|false|null)$/)?"":"$obj.")+a}).replace(/\.?\.?\[(`\]|[^\]])*\]|\?.*|\.\.([\w\$_]+)|\.\*/g,function(a,b,c){return(b=a.match(/^\.?\.?(\[\s*\^?\?|\^?\?|\[\s*==)(.*?)\]?$/))?(c="",a.match(/^\./)&&(f("expand"),c=",true)"),f(b[1].match(/\=/)?"mapFilter":b[1].match(/\^/)?"distinctFilter":"filterFilter"), c+",function($obj){return "+b[2]+"})"):(b=a.match(/^\[\s*([\/\\].*)\]/))?".concat().sort(function(a,b){"+b[1].replace(/\s*,?\s*([\/\\])\s*([^,\\\/]+)/g,function(a,b,c){return"var av= "+c.replace(/\$obj/,"a")+",bv= "+c.replace(/\$obj/,"b")+";if(av>bv||bv==null){return "+("/"==b?1:-1)+";}\nif(bv>av||av==null){return "+("/"==b?-1:1)+";}\n"})+"return 0;})":(b=a.match(/^\[(-?[0-9]*):(-?[0-9]*):?(-?[0-9]*)\]/))?(f("slice"),","+(b[1]||0)+","+(b[2]||0)+","+(b[3]||1)+")"):a.match(/^\.\.|\.\*|\[\s*\*\s*\]|,/)? (f("expand"),("."==a.charAt(1)?",'"+c+"'":a.match(/,/)?","+a:"")+")"):a}).replace(/(\$obj\s*((\.\s*[\w_$]+\s*)|(\[\s*`([0-9]+)\s*`\]))*)(==|~)\s*`([0-9]+)/g,l).replace(/`([0-9]+)\s*(==|~)\s*(\$obj\s*((\.\s*[\w_$]+)|(\[\s*`([0-9]+)\s*`\]))*)/g,function(a,b,c,e,d,f,g,m){return l(a,e,d,f,g,m,c,b)});c=e+("$"==c.charAt(0)?"":"$")+c.replace(/`([0-9]+|\])/g,function(a,b){return"]"==b?"]":k[b]});for(var b=eval("1&&function($,$1,$2,$3,$4,$5,$6,$7,$8,$9){var $obj=$;return "+c+"}"),a=0;a<arguments.length-1;a++)arguments[a]= arguments[a+1];try{return d?b.apply(this,arguments):b}catch(m){}};exports.query=jsonQuery})(); var Transformer=exports.Transformer=Class.create({initialize:function(c){this._transformCache={};this._transform=c},transform:function(c){return this._populateTemplate(c,this._transform)},merge:function(c,d){return this._mergeThing(c,d,this._transform)},transformAndMerge:function(c,d){return this.merge(c,this.transform(d))},_populateTemplate:function(c,d){var f=this;return Foundations.ObjectUtils.clone(d,{ignoreEmptyObjects:!0,ignoreEmptyArrays:!0,ignoreFunctions:!1,ignorePartialObjects:!0},function(d, g){if(d){if("function"===typeof d)return d(c);if("[object String]"===Object.prototype.toString.call(d)&&"!"==d.charAt(0))return f._expandExpr(c,d.substring(1))}return d})},_expandExpr:function(c,d){function f(c,e,b){return(c=c.exec(e(b)))?c[1]||c[0]:""}var l=this,g=d.replace(/\{([^{]*)\}/g,function(d,e){var b=l._transformCache[e];if(!b){if("/"==e.slice(-1)){b=e.split("/");b.pop();var a=b.pop(),b=f.curry(RegExp(a),jsonQuery(b.join("/")))}else b=jsonQuery(e);l._transformCache[e]=b}try{return b(c)|| ""}catch(g){return""}});if(-1!=g.search(/\S/))return g},_mergeThing:function(c,d,f){if(c!==d)switch(Foundations.ObjectUtils.type(d)){case "boolean":case "null":case "undefined":case "number":case "string":return d;case "array":return c&&"[object Array]"===Object.prototype.toString.call(c)?this._mergeArray(c,d,f):d;case "object":if(c){var l=!1,g;for(g in d){var k=this._mergeThing(c[g],d[g],f?f[g]:void 0);void 0!==k&&(c[g]=k,l=!0)}return l?c:void 0}return d}},_mergeArray:function(c,d,f,l){l=d.length; var g=c.length,k=!1,e,b,a,m;for(e=0;e<l;e++){m=d[e];a=f&&f[e]||m;var r=!0;for(b=0;b<g;b++)if(this._mergeMatch(c[b],m,a)){a=this._mergeThing(c[b],m,a);void 0!==a&&(c[b]=a,k=!0);r=!1;break}r&&(c.push(m),k=!0)}for(b=0;b<c.length;){g=!0;for(e=0;e<l;e++)if(m=d[e],a=f&&f[e]||m,this._mergeMatch(c[b],m,a)){g=!1;break}g?(c.splice(b,1),k=!0):b++}return k?c:void 0},_mergeMatch:function(c,d,f){var l,g,k,e,b=!0;switch(Foundations.ObjectUtils.type(f)){case "boolean":case "undefined":case "null":case "number":return c== d;case "string":return c==d||"!"==f.charAt(0);case "object":if(c){for(l in f)if(!this._mergeMatch(c[l],d[l],f[l]))return!1;return!0}return!1;case "array":if(!c)return!1;l=d.length;g=c.length;if(0===l&&0===g)return!0;if(l!==g)return!1;for(k=0;k<l;k++){b=!1;fmask=f&&f[k]||fi;for(e=0;e<g&&!(b=b||this._mergeMatch(c[e],d[k],fmask));e++);if(!b)break}return b;default:return!1}}}); Transformer.difference=function(c,d){return Foundations.ObjectUtils.clone(d,{ignoreEmptyObjects:!0,ignoreEmptyArrays:!0,ignoreFunctions:!0},function(d,l){return jsonQuery(l,c)===d?void 0:d})}; exports.Schema={validate:function(c,d){return this._validate(c,d,!1)},checkPropertyChange:function(c,d,f){return this._validate(c,d,f||"property")},_validate:function(c,d,f){function l(b){return"[object Array]"===Object.prototype.toString.call(b)}function g(b,a,c,d){function h(a){e.push({property:c,message:a})}function p(a,b){if(a){if("string"==typeof a&&"any"!=a&&("null"==a?null!==b:typeof b!=a)&&!(l(b)&&"array"==a||"integer"==a&&0===b%1))return[{property:c,message:typeof b+" value found, but a "+ a+" is required"}];if(l(a)){for(var d=[],f=0;f<a.length&&(d=p(a[f],b)).length;f++);if(d.length)return d}else if("object"==typeof a)return d=e,e=[],g(b,a,c),f=e,e=d,f}return[]}var n;c+=c?"number"==typeof d?"["+d+"]":"undefined"==typeof d?"":"."+d:d;if(("object"!=typeof a||l(a))&&(c||"function"!=typeof a))return"function"==typeof a?b instanceof a||h("is not an instance of the class/constructor "+a.name):a&&h("Invalid schema/property definition "+a),null;f&&a.readonly&&h("is a readonly field, it can not be changed"); a["extends"]&&g(b,a["extends"],c,d);if(void 0===b)a.optional||h("is missing and it is not optional");else if(e=e.concat(p(a.type,b)),a.disallow&&!p(a.disallow,b).length&&h(" disallowed value was matched"),null!==b){if(l(b)){"array"!==a.type&&a.type!==[]&&e.push({property:c,message:"an object is required"});if(a.items)if(l(a.items))for(d=0,n=b.length;d<n;d++)e.concat(g(b[d],a.items[d],c,d));else for(d=0,n=b.length;d<n;d++)e.concat(g(b[d],a.items,c,d));a.minItems&&b.length<a.minItems&&h("There must be a minimum of "+ a.minItems+" in the array");a.maxItems&&b.length>a.maxItems&&h("There must be a maximum of "+a.maxItems+" in the array")}else a.properties&&e.concat(k(b,a.properties,c,a.additionalProperties));a.pattern&&("string"==typeof b&&!b.match(a.pattern))&&h("does not match the regex pattern "+a.pattern);a.maxLength&&("string"==typeof b&&b.length>a.maxLength)&&h("may only be "+a.maxLength+" characters long");a.minLength&&("string"==typeof b&&b.length<a.minLength)&&h("must be at least "+a.minLength+" characters long"); void 0!==typeof a.minimum&&(typeof b==typeof a.minimum&&a.minimum>b)&&h("must have a minimum value of "+a.minimum);void 0!==typeof a.maximum&&(typeof b==typeof a.maximum&&a.maximum<b)&&h("must have a maximum value of "+a.maximum);if(a["enum"]){d=a["enum"];n=d.length;for(var s,q=0;q<n;q++)if(d[q]===b){s=1;break}s||h("does not have a value in the enumeration "+d.join(", "))}"number"==typeof a.maxDecimal&&b.toString().match(RegExp("\\.[0-9]{"+(a.maxDecimal+1)+",}"))&&h("may only have "+a.maxDecimal+ " digits of decimal places")}return null}function k(b,a,c,d){if("object"==typeof a){("object"!=typeof b||l(b))&&e.push({property:c,message:"an object is required"});for(var h in a)if(a.hasOwnProperty(h)&&("_"!=h.charAt(0)||"_"!=h.charAt(1))){var k=b[h];g(k,a[h],c,h)}}for(h in b)!b.hasOwnProperty(h)||("_"==h.charAt(0)&&"_"==h.charAt(1)||!a||a[h]||!1!==d)||e.push({property:c,message:"The property "+h+" is not defined in the schema and the schema does not allow additional properties"}),k=a&&a[h]&&a[h].requires, !k||k in b||e.push({property:c,message:"the presence of the property "+h+" requires that "+k+" also be present"}),k=b[h],!a||("object"!=typeof a||h in a)||g(k,d,c,h),!f&&(k&&k.$schema)&&(e=e.concat(g(k,k.$schema,c,h)));return e}var e=[];d&&g(c,d,"",f||"");!f&&(c&&c.$schema)&&g(c,c.$schema,"","");return{valid:!e.length,errors:e}}};
